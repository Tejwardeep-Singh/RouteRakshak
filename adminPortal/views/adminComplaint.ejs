
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="/css/style.css">
    <title>Route Rakshak | Admin </title>
</head>
<body>
    <main>
        <nav>
            <div class="nl"></div>
            <div class="nr">
                <a href="/admin">Home</a>
                <a href="/admin/login">Login</a>
                <a href="/admin/dashboard">Dashboard</a>
                <a href="/admin/logout">Logout</a>
            </div>
        </nav>
        <div id="page1">
            <div id="pg1-container">
                <h2>Ward <%= ward.wardNumber %> Complaints</h2>

            <!-- üó∫Ô∏è Map -->
            <div id="map"></div>

            <!-- üìã Complaint Tiles -->
            <div>
            <% if (complaints2.length === 0) { %>
                <p>No complaints found.</p>
            <% } %>

            <% complaints2.forEach(complaint => { %>
                <div class="complaint-tile">

                    <h3><%= complaint.locationText %></h3>

                    <span class="status-badge <%= complaint.status %>">
                        <%= complaint.status %>
                    </span>

                    <p><%= complaint.message %></p>

                    <a href="/admin/complaint/<%= complaint._id %>">
                        View Details ‚Üí
                    </a>

                </div>
            <% }) %>
            </div>
            </div>
        </div>
         <div id="copywright">
            <p>&copy; <span id="year"></span> ATES Squad. All rights reserved.</p>
        </div>
    </main>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script id="wardData" type="application/json">
        <%- JSON.stringify(ward.geometry) %>
    </script>
    <script id="complaintsData" type="application/json">
            <%- JSON.stringify(complaints) %>
    </script>

    <script>
    const map = L.map('map').setView([31.6340, 74.8723], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18
    }).addTo(map);

    const wardGeoJSON = JSON.parse(
        document.getElementById("wardData").textContent
    );

    
    const wardLayer = L.geoJSON(wardGeoJSON, {
    style: {
        color: "#111",
        weight: 3,
        fillOpacity: 0.3
    }
}).addTo(map);

map.fitBounds(wardLayer.getBounds());

    const complaintsData = JSON.parse(
        document.getElementById("complaintsData").textContent
    );

    complaintsData.forEach(c => {

        if (!c.location || !c.location.coordinates) return;

        const lng = c.location.coordinates[0];
        const lat = c.location.coordinates[1];

        let color = "red";
        if (c.status === "resolved") color = "orange";
        if (c.status === "completed") color = "green";

        const marker = L.circleMarker([lat, lng], {
            radius: 4,
            color: color,
            fillColor: color,
            fillOpacity: 0.9,
  weight: 2
        }).addTo(map);

        marker.bindPopup(`
            <strong>${c.locationText || "Complaint"}</strong><br>
            Status: ${c.status}
        `);
    });
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function () {
    const div = L.DomUtil.create("div", "info legend");

    div.innerHTML = `
        <strong>Status</strong><br>
        <span style="color:red;">‚óè</span> Pending<br>
        <span style="color:orange;">‚óè</span> Resolved<br>
        <span style="color:green;">‚óè</span> Completed
    `;

    div.style.background = "white";
    div.style.padding = "10px";
    div.style.borderRadius = "8px";

    return div;
    };

legend.addTo(map);

    </script>
    <script>
        const currentYear = new Date().getFullYear();
        document.getElementById('year').textContent = currentYear;
    </script>
    
    <script src="/admin/js/script.js"></script>
</body>
</html>
        