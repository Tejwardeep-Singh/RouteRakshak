<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="/css/style.css">
    <title>Route Rakshak | Citizen </title>
</head>
<body>
    <main>
        <nav>
            <div class="nl"></div>
            <div class="nr">
                <a href="/">Home</a>
                <a href="/login">Login</a>
            </div>
        </nav>
        <section class="map-section">
            <div class="map-header">
                <h1>Smart Route Planner</h1>
                <p>Find the safest path across Amritsar</p>
            </div>

            <div class="map-wrapper">

                <div class="control-panel">
                    <input type="text" id="source" placeholder="Enter source (lat,lng)">
                    <button onclick="useMyLocation()">üìç Use My Location</button>

                    <input type="text" id="destination" placeholder="Enter destination (lat,lng)">
                    <button onclick="getSafeRoute()">üö¶ Find Safest Route</button>
                </div>

                <div id="routeMap"></div>

            </div>
            <div id="routeLoader" class="route-loader">
                <div class="loader-spinner"></div>
                <p>Finding safest route...</p>
            </div>
        </section>

        <div id="copywright">
            <p>&copy; <span id="year"></span> ATES Squad. All rights reserved.</p>
        </div>
    </main>
    

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const roadsData = JSON.parse('<%- JSON.stringify(roads || []) %>');

        const map = L.map('routeMap').setView([31.6340, 74.8723], 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18
        }).addTo(map);

        const roadsLayer = L.layerGroup().addTo(map);
        const routeLayer = L.layerGroup().addTo(map);
        const markerLayer = L.layerGroup().addTo(map);

       
        roadsData.forEach(road => {

            if (!road.geometry || !road.geometry.coordinates) return;

            const latLngCoords = road.geometry.coordinates.map(coord => [
                coord[1],
                coord[0]
            ]);

            let color = "green";
            const condition = (road.condition || "").toLowerCase();

            if (condition === "damaged") color = "red";
            if (condition === "under_repair") color = "orange";

            L.polyline(latLngCoords, {
                color: color,
                weight: 4 + (road.severity || 1),
                opacity: 0.8
            }).bindPopup(`
                <b>${road.name || "Road"}</b><br>
                Condition: ${road.condition}<br>
                Severity: ${road.severity || 0}
            `).addTo(roadsLayer);
        });


       function useMyLocation() {
            if (!navigator.geolocation) {
                alert("Geolocation not supported");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                pos => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;

                    document.getElementById("source").value = lat + "," + lng;

                    markerLayer.clearLayers();

                    L.marker([lat, lng])
                        .bindPopup("You are here")
                        .addTo(markerLayer);

                    map.setView([lat, lng], 15);
                },
                err => {
                    alert("Location permission denied or blocked.");
                    console.error(err);
                }
            );
        }


        async function getSafeRoute() {
            const loader = document.getElementById("routeLoader");
            const button = document.querySelector(".control-panel button:last-child");

            loader.classList.add("active");
            button.disabled = true;

            try {

                const source = document.getElementById("source").value;
                const destination = document.getElementById("destination").value;

                const response = await fetch("/safe-route", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ source, destination })
                });

                const data = await response.json();

                routeLayer.clearLayers();
                console.log("SERVER RESPONSE:", data);


                if (!data || !data.route || !data.route.geometry || !data.route.geometry.coordinates) {
                    loader.classList.remove("active");
                    button.disabled = false;
                    return;
                }


                const routeCoords = data.route.geometry.coordinates.map(coord => [
                    coord[1],
                    coord[0]
                ]);

                L.polyline(routeCoords, {
                    color: "blue",
                    weight: 4,
                    opacity: 0.7,
                    dashArray: "6,6"
                }).addTo(routeLayer);

                routeLayer.bringToFront();
                map.fitBounds(routeLayer.getBounds());

            } catch (error) {
                console.error(error);
            }

            loader.classList.remove("active");
            button.disabled = false;
        }



        const legend = L.control({ position: "bottomright" });

        legend.onAdd = function () {
            const div = L.DomUtil.create("div", "legend");
            div.innerHTML = `
                <b>Road Conditions</b><br>
                <span style="color:green;">‚ñ†</span> Good<br>
                <span style="color:orange;">‚ñ†</span> Under Repair<br>
                <span style="color:red;">‚ñ†</span> Damaged<br>
                <span style="color:blue;">‚ñ†</span> Best Route
            `;
            return div;
        };

        legend.addTo(map);

    </script>

     <script>
        const currentYear = new Date().getFullYear();
        document.getElementById('year').textContent = currentYear;
    </script>
    <!-- <script id="roadsData" type="application/json">
        const roadsData = <%- JSON.stringify(roads) %>;
        console.log("ROADS:", roadsData);
    </script> -->
    <!-- <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        function useMyLocation() {

    if (!navigator.geolocation) {
        alert("Geolocation not supported");
        return;
    }

    navigator.geolocation.getCurrentPosition(
        function(position) {

            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            document.getElementById("source").value = lat + "," + lng;

            
            L.marker([lat, lng])
              .addTo(routeMap)
              .bindPopup("You are here")
              .openPopup();

            routeMap.setView([lat, lng], 15);

        },
        function(error) {
            alert("Location permission denied");
        }
    );
}

    const routeMap = L.map('routeMap').setView([31.6340, 74.8723], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18
    }).addTo(routeMap);

    let currentRouteLayer;
    const roadsData = JSON.parse(
    document.getElementById("roadsData").textContent
);
console.log("ROADS:", roadsData);

roadsData.forEach(road => {
    console.log("FULL ROAD OBJECT:", road);
    console.log("GEOMETRY:", road.geometry);
    console.log("COORDINATES:", road.geometry?.coordinates);

    if (!road.geometry) return;
    // Convert [lng, lat] to [lat, lng]
    const latLngCoords = road.geometry.coordinates.map(coord => [
        coord[1],  // lat
        coord[0]   // lng
    ]);

    let condition = road.condition?.toLowerCase().trim();
    let color = "green";

    if (condition === "damaged") color = "red";
    else if (condition === "under_repair") color = "orange";

    L.polyline(latLngCoords, {
        color: color,
        weight: 6
    }).addTo(routeMap);

});



    async function getSafeRoute() {

        const source = document.getElementById("source").value;
        const destination = document.getElementById("destination").value;

        const response = await fetch("/safe-route", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ source, destination })
        });

        const data = await response.json();

        if (currentRouteLayer) {
            routeMap.removeLayer(currentRouteLayer);
        }

        currentRouteLayer = L.geoJSON(data.route, {
            style: {
                color: "blue",
                weight: 6
            }
        }).addTo(routeMap);

        routeMap.fitBounds(currentRouteLayer.getBounds());
    }
    
    </script> -->
    <script src="/js/script.js"></script>
</body>
</html>